<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Handshake - J-PAKE over TLS</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../tls/tls.html"><strong aria-hidden="true">2.</strong> Introduction of TLS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tls/handshake.html" class="active"><strong aria-hidden="true">2.1.</strong> Handshake</a></li><li class="chapter-item expanded "><a href="../tls/cert_auth.html"><strong aria-hidden="true">2.2.</strong> Certificate Authentication</a></li></ol></li><li class="chapter-item expanded "><a href="../pake/pake.html"><strong aria-hidden="true">3.</strong> PAKE: Password authenticated Key Exchange</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pake/security_requirements.html"><strong aria-hidden="true">3.1.</strong> Security Requirements</a></li><li class="chapter-item expanded "><a href="../pake/two_stages.html"><strong aria-hidden="true">3.2.</strong> General Two-Stage Framework</a></li><li class="chapter-item expanded "><a href="../pake/balanced/balanced_pake.html"><strong aria-hidden="true">3.3.</strong> Balanced PAKE</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pake/balanced/dh-eke.html"><strong aria-hidden="true">3.3.1.</strong> DH-EKE: Diffie-Hellman Encrypted key exchange</a></li><li class="chapter-item expanded "><a href="../pake/balanced/speke.html"><strong aria-hidden="true">3.3.2.</strong> SPEKE: Simple Password Exponential Key Exchange</a></li></ol></li><li class="chapter-item expanded "><a href="../pake/augmented/augmented_pake.html"><strong aria-hidden="true">3.4.</strong> Augmented PAKE</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pake/augmented/srp.html"><strong aria-hidden="true">3.4.1.</strong> SRP: Secure Remote Password protocol</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../pake/balanced/jpake/intro.html"><strong aria-hidden="true">4.</strong> J-PAKE: Password Authenticated Key Exchange by Juggling</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pake/balanced/jpake/jpake.html"><strong aria-hidden="true">4.1.</strong> J-PAKE protocol</a></li><li class="chapter-item expanded "><a href="../pake/balanced/jpake/security.html"><strong aria-hidden="true">4.2.</strong> Security</a></li><li class="chapter-item expanded "><a href="../pake/balanced/jpake/comparison.html"><strong aria-hidden="true">4.3.</strong> Comparison</a></li></ol></li><li class="chapter-item expanded "><a href="../pake/balanced/jpake/jpake_over_tls.html"><strong aria-hidden="true">5.</strong> J-PAKE over TLS</a></li><li class="chapter-item expanded "><a href="../discussion.html"><strong aria-hidden="true">6.</strong> Discussion</a></li><li class="chapter-item expanded "><a href="../appendix/index.html"><strong aria-hidden="true">7.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../appendix/hash.html"><strong aria-hidden="true">7.1.</strong> Hash function</a></li><li class="chapter-item expanded "><a href="../appendix/modular_arithmetic.html"><strong aria-hidden="true">7.2.</strong> Modular Arithmetic</a></li><li class="chapter-item expanded "><a href="../appendix/gcd.html"><strong aria-hidden="true">7.3.</strong> GCD: Greatest Common Divisors</a></li><li class="chapter-item expanded "><a href="../appendix/group_theory.html"><strong aria-hidden="true">7.4.</strong> Group Theory</a></li><li class="chapter-item expanded "><a href="../appendix/trapdoor_function.html"><strong aria-hidden="true">7.5.</strong> Trapdoor Function</a></li><li class="chapter-item expanded "><a href="../appendix/dh/dh.html"><strong aria-hidden="true">7.6.</strong> Diffie-Hellman Key Exchange</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../appendix/dh/dh_multiple_parties.html"><strong aria-hidden="true">7.6.1.</strong> Diffie-Hellman with Multiple Parties</a></li><li class="chapter-item expanded "><a href="../appendix/dh/assumptions.html"><strong aria-hidden="true">7.6.2.</strong> Diffie-Hellman Assumptions</a></li></ol></li><li class="chapter-item expanded "><a href="../appendix/zkp/zkp.html"><strong aria-hidden="true">7.7.</strong> Zero-Knowledge Proof</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../appendix/zkp/schnorr_signature.html"><strong aria-hidden="true">7.7.1.</strong> Schnorr Signature</a></li></ol></li><li class="chapter-item expanded "><a href="../appendix/ecc.html"><strong aria-hidden="true">7.8.</strong> Elliptic Curve Cryptography</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">J-PAKE over TLS</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="handshake"><a class="header" href="#handshake">Handshake</a></h1>
<p><img src="tls-handshake.png" alt="tls-handshake" /></p>
<p>Diagram is generated by <a href="https://goo.gl/BTLkqf" title="WebSequenceDiagrams.com">WebSequenceDiagrams.com</a></p>
<h2 id="client-hello"><a class="header" href="#client-hello">Client Hello</a></h2>
<p>The client and the server support several versions of TLS.
To make sure they have a matched version to communicate,
the client first will send its list of supported TLS versions.</p>
<p>In the same manner,
the client and the server support many ciphers and compression and etc.,
some might be same, some might be different.
To make sure they can use the same methods on both side,
the client need to send its lists of supported ciphers/compression/etc.
to the server.</p>
<p>In addition, the client will generate a random number <strong>x</strong>.
It will be further used to generate the session key.</p>
<p>In summary, the client will send</p>
<ul>
<li>supported TLS versions</li>
<li>supported ciphers</li>
<li>supported compression</li>
<li>supported ...</li>
<li>a random number <strong>x</strong></li>
</ul>
<h2 id="server-hellowith-server-done"><a class="header" href="#server-hellowith-server-done">Server Hello(with Server Done)</a></h2>
<p>After receiving the <em>Client Hello</em>, server will reply
messages from <em>Server Hello</em> to <em>Server Done</em>.
Some might sends each message respectively,
while the other might send just one message
including <em>Server Hello</em> and <em>Server Done</em>.
The <em>Server Hello</em> and <em>Server Done</em> packet contains only head without content.</p>
<p>The server will search its TLS versions, ciphers, comparison, etc.
and choose the protocols matched with the client.
If there is no matched protocols of them, then the communication will be dropped.
Otherwise, the server will reply the matched protocols to the client.
The replied messages also include server's certificate,
which is a proof for server's identification.
The certificate is given by a <strong>Certificate Authority</strong>.
It will provide certificates to applied parties if they pass strict examines.</p>
<p>The server side will also pick a random number <strong>y</strong>
as an input for generating the session key.</p>
<p>The server can decide whether or not it needs the client's certificate
to prove the identification.
Some applications with higher security requirements may need to ask.</p>
<p>In summary, the server will reply</p>
<ul>
<li>chosen TLS version</li>
<li>chosen ciphers</li>
<li>chosen compression</li>
<li>chosen ...</li>
<li>server's certificate</li>
<li>a random number <strong>y</strong></li>
<li>[ask for client's certificate]</li>
</ul>
<h2 id="client-key-exchange"><a class="header" href="#client-key-exchange">Client Key Exchange</a></h2>
<p>The client needs to verify the server's certificate to check its identification.
If the certificate is invalid, then the client will show a alert
and let user decides whether the communication should be continued.</p>
<p>Next, the client will generate the third random number <strong>z</strong>
in this communication.
Similarly, the <strong>z</strong> is also used to produce the final session key.
In this time, the <strong>z</strong> is encrypted by the server's public key
before sending out.
The server's public key can be obtained from the server's certificate.</p>
<p>If the server asks the client's certificate,
then the client needs to add its certificate into the replied message.</p>
<p>In summary, the client will reply</p>
<ul>
<li>encrypted random number <strong>z</strong></li>
<li>[client's certificate]</li>
</ul>
<h2 id="client-finish"><a class="header" href="#client-finish">Client Finish</a></h2>
<p>From the server's reply, the client can know which TLS version, ciphers,
and other matched methods they will use.
Thus, the client will add a <em>Change Cipher Spec</em> message
to notify the server that the following communication will use the chosen
cipher to encrypt/decrypt the raw data based on their matched TLS version.</p>
<p>After adding <em>Change Cipher Spec</em> message, the client will
encrypt a <em>FINISH</em> message by the session key and send it to the server.
The session key is produced by the random numbers <strong>x, y, z</strong>.</p>
<p>In summary, the client will send</p>
<ul>
<li><em>Change Cipher Spec</em> message</li>
<li>FINISH</li>
</ul>
<h2 id="server-finish"><a class="header" href="#server-finish">Server Finish</a></h2>
<p>On server side, if it requires the client's certificate,
it will verify it upon receiving it.</p>
<p>The same session key can also be derived
from the random numbers <strong>x, y, z</strong>,
where the <strong>z</strong> can be obtained
by decrypting the client's <em>Client Key Exchange</em> messages by its private key.</p>
<p>After computing the session key, the server will also
use a <em>Change Cipher Spec</em> message to notify the client
that the following messages will be encrypted.
By the same token, the message will be sent
with an encrypted <em>FINISH</em> message by using the derived session key.</p>
<p>In summary, the server will send</p>
<ul>
<li><em>Change Cipher Spec</em> message</li>
<li>FINISH</li>
</ul>
<h2 id="authentication"><a class="header" href="#authentication">Authentication</a></h2>
<p>If the both sides can decrypt the FINISH message based on the previous
handshake messages, then it means that the valid channel
is established successfully.
They can use the session key in the following communication.</p>
<h2 id="secret-keys"><a class="header" href="#secret-keys">Secret Keys</a></h2>
<p><img src="tls-secret-keys.png" alt="tls-secret-keys" /></p>
<h3 id="why-does-tls-need-to-generate-a-session-key-can-it-use-the-public-key-directly"><a class="header" href="#why-does-tls-need-to-generate-a-session-key-can-it-use-the-public-key-directly">Why does TLS need to generate a session key? Can it use the public key directly?</a></h3>
<p>The symmetric encryption is faster than the asymmetric one.
TLS protocol allows the engaging parties to negotiate a symmetric key
to boost the encryption instead of directly using
asymmetric public-private key pair.</p>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://segmentfault.com/a/1190000002554673" title="SSL/TLS原理详解">SSL/TLS原理详解</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" title="SSL/TLS协议运行机制的概述">SSL/TLS协议运行机制的概述</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../tls/tls.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../tls/cert_auth.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../tls/tls.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../tls/cert_auth.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
